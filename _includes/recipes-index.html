{%- comment -%}
  _includes/recipes-index.html
  ===========================

  Objectif :
  - Centraliser le rendu des cartes recette (Ã©vite la duplication entre index.html et tag-index.html).

  ParamÃ¨tres attendus :
  - include.grouped     : rÃ©sultat de `group_by: "recipe_group"` (tableau de groupes)
  - include.hidden_tags : liste (array) des tags Ã  masquer sur les cartes

  Contraintes techniques :
  - Le filtre â€œSeulement les recettes testÃ©esâ€ (include filter-tested.html)
    dÃ©pend de `.recipe-item[data-tested="true|false"]`.
  - Le random pick / scripts peuvent lire les attributs data-* sur `.recipe-card-link`,
    notamment `data-title` et `data-subtitle`.
{%- endcomment -%}

{%- comment -%}
  SÃ©curise hidden_tags (Ã©vite les erreurs si lâ€™appelant oublie de le passer).
{%- endcomment -%}
{%- assign hidden_tags = include.hidden_tags | default: "" -%}

{%- comment -%}
  Tri des groupes par nom :
  - Rend lâ€™affichage stable (mÃªme si lâ€™appelant nâ€™a pas triÃ©).
{%- endcomment -%}
{%- assign grouped_sorted = include.grouped | sort: "name" -%}

<div id="recipes-index">
  {%- comment -%}
    Boucle sur chaque groupe (recipe_group).
    On ignore les groupes sans nom pour Ã©viter des ancres vides.
  {%- endcomment -%}
  {%- for g in grouped_sorted -%}
    {%- if g.name and g.name != "" -%}

      <h3 id="{{ g.name | slugify }}" class="recipe-category-title">
        <!-- Titre du groupe cliquable (ancre locale) -->
        <a href="#{{ g.name | slugify }}">{{ g.name }}</a>
      </h3>

      <div class="recipe-group-block mb-4" data-recipe-group="{{ g.name | escape }}">
        {%- comment -%}
          Tri des recettes dans le groupe :
          - Utilise `recipe_sort` (clÃ© fonctionnelle courte) pour un ordre stable.
        {%- endcomment -%}
        {%- assign group_recipes = g.items | sort: "recipe_sort" -%}

        <div class="recipes-grid">
          {%- comment -%}
            Boucle sur chaque recette du groupe.
          {%- endcomment -%}
          {%- for r in group_recipes -%}

            <!-- =========================================================
                 Wrapper requis pour filter-tested.html
                 ========================================================= -->
            <div
              class="recipe-item"
              data-tested="{% if r.recipe_tested == true %}true{% else %}false{% endif %}"
            >

              <article
                class="recipe-card mb-2"
                data-tags="{{ r.tags | join: ',' | escape }}"
                data-micros="{{ r.badges_nutritionnels | join: ',' | escape }}"
              >
                <a
                  class="recipe-card-link"
                  href="{{ r.url | relative_url }}"
                  data-tested="{% if r.recipe_tested == true %}true{% else %}false{% endif %}"
                  data-title="{{ r.recipe_title | escape }}"
                  data-subtitle="{{ r.recipe_subtitle | default: '' | strip_html | escape }}"
                >
                  <div class="recipe-card-top">
                    <h4 class="recipe-card-title">{{ r.recipe_title }}</h4>
                  </div>

                  {%- if r.recipe_subtitle -%}
                    <p class="recipe-card-subtitle mb-1">{{ r.recipe_subtitle }}</p>
                  {%- endif -%}

                  {%- if r.recipe_tested == false -%}
                    <span class="badge bg-warning text-dark mb-2">Recette non testÃ©e</span>
                  {%- endif -%}

                  <div class="recipe-badges-wrap">
                    {%- if r.tags -%}
                      <ul class="recipe-badges-line badges-tags" aria-label="Badges">
                        {%- for tag in r.tags -%}
                          {%- unless hidden_tags contains tag -%}
                            {%- case tag -%}
                              {%- when "tres-proteine" -%}<li title="TrÃ¨s protÃ©inÃ©">ğŸ’ª</li>
                              {%- when "riche-en-fibres" -%}<li title="Riche en fibres">ğŸ’©</li>
                              {%- when "rapide" -%}<li title="Rapide">â±ï¸</li>
                              {%- when "congelable" -%}<li title="CongÃ©lable">â„ï¸</li>
                              {%- when "micro-ondable" -%}<li title="Micro-ondable">â™¨ï¸</li>
                              {%- when "peu-calorique" -%}<li title="Peu calorique">ğŸª¶</li>
                              {%- when "calorique" -%}<li title="Calorique">ğŸ”¥</li>
                              {%- when "longue" -%}<li title="PrÃ©paration longue">ğŸŒ</li>
                            {%- endcase -%}
                          {%- endunless -%}
                        {%- endfor -%}
                      </ul>
                    {%- endif -%}

                    {%- assign micros = r.badges_nutritionnels | default: "" -%}
                    {%- if micros and micros.size > 0 -%}
                      <ul class="recipe-badges-line badges-micro" aria-label="Micronutriments">
                        {%- for m in micros -%}
                          {%- case m -%}
                            {%- when "omega-3" -%}<li title="OmÃ©ga-3">ğŸŸ</li>
                            {%- when "vitamine-a" -%}<li title="Vitamine A">ğŸ‘ï¸</li>
                            {%- when "vitamine-c" -%}<li title="Vitamine C">ğŸ‹</li>
                            {%- when "vitamine-d" -%}<li title="Vitamine D">ğŸŒ¤ï¸</li>
                            {%- when "vitamine-e" -%}<li title="Vitamine E">ğŸ›¡ï¸</li>
                            {%- when "vitamine-k" -%}<li title="Vitamine K">ğŸ©¸</li>
                            {%- when "vitamine-b9" -%}<li title="Vitamine B9">ğŸŒ±</li>
                            {%- when "vitamine-b12" -%}<li title="Vitamine B12">ğŸ¥©</li>
                            {%- when "calcium" -%}<li title="Calcium">ğŸ¦´</li>
                            {%- when "fer" -%}<li title="Fer">ğŸ§²</li>
                            {%- when "magnesium" -%}<li title="MagnÃ©sium">âš¡</li>
                            {%- when "potassium" -%}<li title="Potassium">ğŸŒ</li>
                            {%- when "zinc" -%}<li title="Zinc">ğŸ”©</li>
                            {%- when "selenium" -%}<li title="SÃ©lÃ©nium">ğŸ§ª</li>
                            {%- when "iode" -%}<li title="Iode">ğŸŒŠ</li>
                          {%- endcase -%}
                        {%- endfor -%}
                      </ul>
                    {%- endif -%}
                  </div>

                </a>
              </article>

            </div>
          {%- endfor -%}
        </div>
      </div>

    {%- endif -%}
  {%- endfor -%}
</div>

