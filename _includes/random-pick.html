{%- comment -%}
  =========================================================
  INCLUDE : RANDOM PICK (On mange quoi ?)
  Fichier : _includes/random-pick.html

  RÃ´le :
  - Affiche une suggestion alÃ©atoire de recette (hors "gout-sucre")
  - Exclut certains recipe_group du tirage
  - Affiche les badges (tags + micronutriments) de la recette tirÃ©e

  Options (include.*) :
  - include.hide_links : si true, masque les 2 lignes de liens fixes (tags + micros)
    (utile sur les pages badges qui ont dÃ©jÃ  une navigation par badges)

  Mode "page filtrÃ©e" (auto) :
  - Si document.body.dataset.filterType = "tag"|"micro"
    ET document.body.dataset.filterId = "<id>"
    alors le random pick ne tire que dans les cartes qui matchent ce filtre.
    (utile pour les pages /tags/* et /micronutriments/*)
  =========================================================
{%- endcomment -%}

<!-- =========================================================
     SUGGESTION ALÃ‰ATOIRE
     ========================================================= -->
<div class="mb-4">

  <!-- Zone oÃ¹ la â€œpick-cardâ€ est injectÃ©e par JS -->
  <div id="random-pick"></div>

  {%- comment -%}
    âœ… Bloc â€œinfos tags + micronutrimentsâ€
    - HORS tirage : navigation rapide.
    - On inclut volontairement "gout-sucre" ici, mÃªme sâ€™il est exclu du tirage.
    - Masquable via include.hide_links pour Ã©viter les doublons.
  {%- endcomment -%}
  {%- unless include.hide_links -%}
    <div class="random-pick-links mt-2">

      <!-- Ligne 1 : tags fonctionnels -->
      <ul class="recipe-badges-line badges-tags-fixed" aria-label="Tags fonctionnels">
        <li><a class="badge-link-outside" href="{{ '/tags/tres-proteine/' | relative_url }}" title="TrÃ¨s protÃ©inÃ©">ğŸ’ª</a></li>
        <li><a class="badge-link-outside" href="{{ '/tags/riche-en-fibres/' | relative_url }}" title="Riche en fibres">ğŸ’©</a></li>
        <li><a class="badge-link-outside" href="{{ '/tags/rapide/' | relative_url }}" title="Rapide">â±ï¸</a></li>
        <li><a class="badge-link-outside" href="{{ '/tags/congelable/' | relative_url }}" title="CongÃ©lable">â„ï¸</a></li>
        <li><a class="badge-link-outside" href="{{ '/tags/micro-ondable/' | relative_url }}" title="Micro-ondable">â™¨ï¸</a></li>
        <li><a class="badge-link-outside" href="{{ '/tags/peu-calorique/' | relative_url }}" title="Peu calorique">ğŸª¶</a></li>
        <li><a class="badge-link-outside" href="{{ '/tags/calorique/' | relative_url }}" title="Calorique">ğŸ”¥</a></li>
        <li><a class="badge-link-outside" href="{{ '/tags/longue/' | relative_url }}" title="PrÃ©paration longue">ğŸŒ</a></li>

        <!-- Tag cachÃ© dans les badges des cartes, mais OK en navigation -->
        <li><a class="badge-link-outside" href="{{ '/tags/gout-sucre/' | relative_url }}" title="GoÃ»t sucrÃ©">ğŸ¬</a></li>
      </ul>

      <!-- Ligne 2 : micronutriments -->
      <ul class="recipe-badges-line badges-micro-fixed" aria-label="Micronutriments">
        <li><a class="badge-link-outside" href="{{ '/micronutriments/omega-3/' | relative_url }}" title="OmÃ©ga-3">ğŸŸ</a></li>

        <li><a class="badge-link-outside" href="{{ '/micronutriments/vitamine-a/' | relative_url }}" title="Vitamine A">ğŸ‘ï¸</a></li>
        <li><a class="badge-link-outside" href="{{ '/micronutriments/vitamine-c/' | relative_url }}" title="Vitamine C">ğŸ‹</a></li>
        <li><a class="badge-link-outside" href="{{ '/micronutriments/vitamine-d/' | relative_url }}" title="Vitamine D">ğŸŒ¤ï¸</a></li>
        <li><a class="badge-link-outside" href="{{ '/micronutriments/vitamine-e/' | relative_url }}" title="Vitamine E">ğŸ›¡ï¸</a></li>
        <li><a class="badge-link-outside" href="{{ '/micronutriments/vitamine-k/' | relative_url }}" title="Vitamine K">ğŸ©¸</a></li>
        <li><a class="badge-link-outside" href="{{ '/micronutriments/vitamine-b9/' | relative_url }}" title="Vitamine B9">ğŸŒ±</a></li>
        <li><a class="badge-link-outside" href="{{ '/micronutriments/vitamine-b12/' | relative_url }}" title="Vitamine B12">ğŸ¥©</a></li>

        <li><a class="badge-link-outside" href="{{ '/micronutriments/calcium/' | relative_url }}" title="Calcium">ğŸ¦´</a></li>
        <li><a class="badge-link-outside" href="{{ '/micronutriments/fer/' | relative_url }}" title="Fer">ğŸ§²</a></li>
        <li><a class="badge-link-outside" href="{{ '/micronutriments/magnesium/' | relative_url }}" title="MagnÃ©sium">âš¡</a></li>
        <li><a class="badge-link-outside" href="{{ '/micronutriments/potassium/' | relative_url }}" title="Potassium">ğŸŒ</a></li>
        <li><a class="badge-link-outside" href="{{ '/micronutriments/zinc/' | relative_url }}" title="Zinc">ğŸ”©</a></li>
        <li><a class="badge-link-outside" href="{{ '/micronutriments/selenium/' | relative_url }}" title="SÃ©lÃ©nium">ğŸ§ª</a></li>
        <li><a class="badge-link-outside" href="{{ '/micronutriments/iode/' | relative_url }}" title="Iode">ğŸŒŠ</a></li>
      </ul>

    </div>
  {%- endunless -%}
</div>

<script>
  /*
    =========================================================
    RANDOM PICK
    - Exclut toutes les recettes taguÃ©es "gout-sucre"
    - Exclut certains recipe_group du tirage
    - Affiche aussi les badges (tags + micronutriments) de la recette tirÃ©e
    - Mode page filtrÃ©e :
        body[data-filter-type="tag|micro"][data-filter-id="..."]
      =========================================================
  */

  // On attend que TOUT le DOM soit chargÃ© (car #recipes-index peut Ãªtre plus bas).
  document.addEventListener("DOMContentLoaded", () => {

    // Racine : index des recettes (cartes)
    const indexRoot = document.getElementById("recipes-index");

    // Cible : oÃ¹ on injecte la â€œpick-cardâ€
    const pickHost = document.getElementById("random-pick");

    // Si lâ€™un des Ã©lÃ©ments est absent, on ne fait rien (Ã©vite erreurs console)
    if (!indexRoot || !pickHost) return;

    // ----------------------------
    // MODE "PAGE FILTRÃ‰E" (tags/micros)
    // ----------------------------
    const FILTER_TYPE = (document.body?.dataset?.filterType || "").toLowerCase().trim(); // "tag"|"micro"|"" 
    const FILTER_ID = (document.body?.dataset?.filterId || "").toLowerCase().trim();     // ex: "selenium"

    // Tag exclu du tirage
    const EXCLUDED_TAG = "gout-sucre";

    // Tags cachÃ©s (utiles cÃ´tÃ© data, mais pas affichÃ©s comme badges â€œfonctionnelsâ€)
    const HIDDEN_TAGS = new Set(["low-carb-modere", "low-carb-strict", "gout-sucre"]);

    /*
      Exclusions du tirage alÃ©atoire par recipe_group (comparaison en minuscules).
      IMPORTANT : data-recipe-group contient le nom humain (ex: "Plats Ã  base de viande")
      => on compare en minuscules ici.
    */
    const EXCLUDED_GROUPS = [
      "amuse-bouche",
      "boissons",
      "pains & substituts",
      "pÃ¢tes & fonds",
      "sauces & assaisonnements",
      "lÃ©gumes & accompagnements",
      "prÃ©parations & conservations",
      "barres nutritionnelles"
    ];

    // Mapping tag -> { emoji, title }
    const TAG_BADGES = {
      "tres-proteine":   { emoji: "ğŸ’ª", title: "TrÃ¨s protÃ©inÃ©" },
      "riche-en-fibres": { emoji: "ğŸ’©", title: "Riche en fibres" },
      "rapide":          { emoji: "â±ï¸", title: "Rapide" },
      "congelable":      { emoji: "â„ï¸", title: "CongÃ©lable" },
      "micro-ondable":   { emoji: "â™¨ï¸", title: "Micro-ondable" },
      "peu-calorique":   { emoji: "ğŸª¶", title: "Peu calorique" },
      "calorique":       { emoji: "ğŸ”¥", title: "Calorique" },
      "longue":          { emoji: "ğŸŒ", title: "PrÃ©paration longue" }
    };

    // Mapping micronutriment -> { emoji, title }
    const MICRO_BADGES = {
      "omega-3":      { emoji: "ğŸŸ", title: "OmÃ©ga-3" },

      "vitamine-a":   { emoji: "ğŸ‘ï¸", title: "Vitamine A" },
      "vitamine-c":   { emoji: "ğŸ‹", title: "Vitamine C" },
      "vitamine-d":   { emoji: "ğŸŒ¤ï¸", title: "Vitamine D" },
      "vitamine-e":   { emoji: "ğŸ›¡ï¸", title: "Vitamine E" },
      "vitamine-k":   { emoji: "ğŸ©¸", title: "Vitamine K" },
      "vitamine-b9":  { emoji: "ğŸŒ±", title: "Vitamine B9" },
      "vitamine-b12": { emoji: "ğŸ¥©", title: "Vitamine B12" },

      "calcium":      { emoji: "ğŸ¦´", title: "Calcium" },
      "fer":          { emoji: "ğŸ§²", title: "Fer" },
      "magnesium":    { emoji: "âš¡", title: "MagnÃ©sium" },
      "potassium":    { emoji: "ğŸŒ", title: "Potassium" },
      "zinc":         { emoji: "ğŸ”©", title: "Zinc" },
      "selenium":     { emoji: "ğŸ§ª", title: "SÃ©lÃ©nium" },
      "iode":         { emoji: "ğŸŒŠ", title: "Iode" }
    };

    // Pour Ã©viter de retomber sur la mÃªme recette trop souvent
    let lastHref = null;

    // Convertit "a,b,c" -> ["a","b","c"] en minuscules
    function parseList(str) {
      return (str || "")
        .split(",")
        .map(s => s.trim().toLowerCase())
        .filter(Boolean);
    }

    // VÃ©rifie si le lien correspond Ã  une recette exploitable
    function isValidRecipeLink(a) {
      const href = (a.getAttribute("href") || "").trim();
      if (!href) return false;

      // On ignore les ancres
      if (href.startsWith("#")) return false;

      // Si tu utilises des URLs propres (sans .html), laisse commentÃ©.
      // if (!href.endsWith(".html")) return false;

      const title = (a.dataset.title || a.textContent || "").trim();
      if (!title) return false;

      return true;
    }

    // Exclut les cartes taguÃ©es "gout-sucre"
    function hasExcludedTag(card) {
      const tags = parseList(card?.dataset?.tags);
      return tags.includes(EXCLUDED_TAG);
    }

    // Exclut certains recipe_group
    function isInExcludedGroup(a) {
      const groupEl = a.closest("[data-recipe-group]");
      if (!groupEl) return false;

      const group = (groupEl.dataset.recipeGroup || "").toLowerCase().trim();
      return EXCLUDED_GROUPS.includes(group);
    }

    // VÃ©rifie que la carte correspond au filtre courant (si prÃ©sent)
    function matchesPageFilter(card) {
      // Pas de filtre => tout passe
      if (!FILTER_TYPE || !FILTER_ID) return true;

      if (FILTER_TYPE === "tag") {
        const tags = parseList(card?.dataset?.tags);
        return tags.includes(FILTER_ID);
      }

      if (FILTER_TYPE === "micro") {
        const micros = parseList(card?.dataset?.micros);
        return micros.includes(FILTER_ID);
      }

      // Type inconnu => on ne filtre pas (sÃ©curitÃ©)
      return true;
    }

    // Liste des candidats au tirage
    function getCandidates() {
      return Array.from(indexRoot.querySelectorAll(".recipe-card a[href]"))
        .filter(isValidRecipeLink)
        .filter(a => {
          const card = a.closest(".recipe-card");
          if (!card) return false;

          // Exclusions globales
          if (hasExcludedTag(card)) return false;
          if (isInExcludedGroup(a)) return false;

          // Filtre de page (tags/micros)
          if (!matchesPageFilter(card)) return false;

          return true;
        });
    }

    // Tirage alÃ©atoire (Ã©vite de rÃ©pÃ©ter la mÃªme recette)
    function pickRandom(links) {
      if (!links.length) return null;

      let a, tries = 0;
      do {
        a = links[Math.floor(Math.random() * links.length)];
        tries++;
      } while (a.getAttribute("href") === lastHref && tries < 20);

      lastHref = a.getAttribute("href");
      return a;
    }

    // Construit une ligne de badges (UL) Ã  partir dâ€™une liste dâ€™IDs et dâ€™un mapping
    function buildBadgeLine(items, map, ariaLabel) {
      const lis = items
        .map(id => {
          const info = map[id];
          if (!info) return "";
          const title = (info.title || "").replace(/"/g, "&quot;");
          return `<li title="${title}">${info.emoji}</li>`;
        })
        .filter(Boolean)
        .join("");

      if (!lis) return "";
      return `<ul class="recipe-badges-line" aria-label="${ariaLabel}">${lis}</ul>`;
    }

    // Badges Ã  afficher dans le random pick pour UNE recette
    function buildPickBadges(card) {
      const tagsAll = parseList(card?.dataset?.tags);

      // Tags fonctionnels : on enlÃ¨ve les tags cachÃ©s + on garde seulement ceux connus
      const tagsFunctional = tagsAll.filter(t => !HIDDEN_TAGS.has(t) && TAG_BADGES[t]);

      const microsAll = parseList(card?.dataset?.micros);
      const micros = microsAll.filter(m => MICRO_BADGES[m]);

      const line1 = buildBadgeLine(tagsFunctional, TAG_BADGES, "Badges");
      const line2 = buildBadgeLine(micros, MICRO_BADGES, "Micronutriments");

      if (!line1 && !line2) return "";
      return `
        <div class="recipe-badges-wrap">
          ${line1}
          ${line2}
        </div>
      `;
    }

    // Affiche la carte â€œOn mange quoi ?â€
    function renderPick(a) {
      const title = (a.dataset.title || a.textContent || "").trim();
      const subtitle = (a.dataset.subtitle || "").trim();
      const tested = a.dataset.tested === "true";
      const href = a.getAttribute("href");

      const card = a.closest(".recipe-card");
      const badgesHtml = buildPickBadges(card);

      pickHost.innerHTML = `
        <div class="pick-card">
          <div class="pick-card-body text-center">
            <div class="mb-2 fw-bold fs-4">On mange quoi&nbsp;?</div>

            <h3 class="h5 mb-1">
              ${title}
              ${tested ? "" : `
                <span class="badge bg-warning text-dark ms-2">
                  Recette non testÃ©e
                </span>
              `}
            </h3>

            ${subtitle ? `<div class="recipe-card-subtitle mb-2">${subtitle}</div>` : ""}

            ${badgesHtml}

            <div class="d-flex justify-content-center gap-2 mt-3">
              <a class="btn btn-primary" href="${href}">Ã‡a me plaÃ®t</a>
              <button id="btn-reroll" type="button" class="btn btn-outline-secondary">
                Autre idÃ©e
              </button>
            </div>
          </div>
        </div>
      `;

      // Bouton â€œAutre idÃ©eâ€ : relance un tirage
      document.getElementById("btn-reroll").onclick = pickAndRender;
    }

    // Cas oÃ¹ aucun candidat nâ€™existe
    function renderEmpty() {
      pickHost.innerHTML = `
        <div class="alert alert-warning mb-0">
          Aucune recette disponible.
        </div>
      `;
    }

    // Orchestration : rÃ©cupÃ¨re candidats -> tire -> rend
    function pickAndRender() {
      const links = getCandidates();
      if (!links.length) return renderEmpty();

      const a = pickRandom(links);
      if (!a) return renderEmpty();

      renderPick(a);
    }

    // Lancement initial
    pickAndRender();
  });
</script>
