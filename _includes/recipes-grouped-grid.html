{%- comment -%}
==============================================================================
recipes-grouped-grid.html â€” Rendu mutualisÃ© des listes de fiches/recettes
==============================================================================

RÃ´le
- Afficher une collection de pages "recipe" sous forme :
  â€¢ compteur total + compteur testÃ©es
  â€¢ filtre â€œrecettes testÃ©esâ€ si pertinent
  â€¢ regroupement par recipe_group
  â€¢ grille de cartes (titre, sous-titre, statut testÃ©e, CTA, badges)

EntrÃ©es (include params)
- recipes   : Array<Page> (obligatoire)
- cta_label : LibellÃ© du bouton (optionnel, dÃ©faut "Voir la fiche")

Contrats / dÃ©pendances
- filter-tested.html :
  â€¢ nâ€™est affichÃ© que si au moins une fiche de la sÃ©lection est non testÃ©e.
  â€¢ JS sâ€™appuie sur `.recipe-item[data-tested]`.
- recipes-search.html :
  â€¢ filtre via `.recipe-item[data-search]`.

Contraintes
- Robustesse : certains contenus peuvent ne pas avoir de tags ou de micronutriments.
- Tri : recipe_group (nom) puis recipe_sort (au sein du groupe).
==============================================================================
{%- endcomment -%}

{%- assign cta = include.cta_label | default: "Voir la fiche" -%}

{%- comment -%}
  Tags techniques masquÃ©s dans lâ€™UI des cartes (classification interne).
{%- endcomment -%}
{%- assign hidden_tags = "low-carb-modere,low-carb-strict" | split: "," -%}

{%- comment -%}
  Comptage des fiches testÃ©es (pour le compteur + condition dâ€™affichage du filtre).
{%- endcomment -%}
{%- assign tested_count = 0 -%}
{%- for r in include.recipes -%}
  {%- if r.recipe_tested == true -%}
    {%- assign tested_count = tested_count | plus: 1 -%}
  {%- endif -%}
{%- endfor -%}

<p class="small text-muted mb-2">
  <strong>{{ include.recipes.size }}</strong> fiche(s).
  <span class="ms-2">TestÃ©e(s) : <strong>{{ tested_count }}</strong>.</span>
</p>

{%- comment -%}
  Filtre â€œrecettes testÃ©esâ€ :
  - affichÃ© uniquement si la sÃ©lection contient au moins une fiche non testÃ©e.
{%- endcomment -%}
{%- if include.recipes.size > tested_count -%}
  {% include filter-tested.html %}
{%- endif -%}

{%- comment -%}
  Regroupement :
  - group_by sur recipe_group
  - exclusion des groupes vides
  - tri par nom
{%- endcomment -%}
{%- assign grouped_raw = include.recipes | group_by: "recipe_group" -%}
{%- assign grouped = "" | split: "" -%}

{%- for g in grouped_raw -%}
  {%- if g.name and g.name != "" -%}
    {%- assign grouped = grouped | push: g -%}
  {%- endif -%}
{%- endfor -%}

{%- assign grouped = grouped | sort: "name" -%}

<div id="recipes-index">
  {% for g in grouped %}
    <h3 id="{{ g.name | slugify }}" class="recipe-category-title">
      <a href="#{{ g.name | slugify }}">{{ g.name }}</a>
    </h3>

    <div class="recipe-group-block mb-4" data-recipe-group="{{ g.name | escape }}">
      {% assign group_recipes = g.items | sort: "recipe_sort" %}

      <div class="recipes-grid">
        {% for r in group_recipes %}

          {%- comment -%}
            Champ de recherche :
            - utilisÃ© par recipes-search.html
            - CONTRAINTE : recherche limitÃ©e STRICTEMENT au titre (recipe_title).
            - normalisation (accents/ligatures) faite cÃ´tÃ© JS.
          {%- endcomment -%}
          {%- assign search_blob = r.recipe_title -%}

          <div
            class="recipe-item"
            data-tested="{% if r.recipe_tested == true %}true{% else %}false{% endif %}"
            data-search="{{ search_blob | strip_html | strip | escape }}"
          >
            <article
              class="recipe-card mb-2"
              data-tags="{% if r.tags %}{{ r.tags | join: ',' | escape }}{% endif %}"
              data-micros="{% if r.badges_nutritionnels %}{{ r.badges_nutritionnels | join: ',' | escape }}{% endif %}"
            >
              <div class="recipe-card-top">
                <h4 class="recipe-card-title">
                  <a class="recipe-title-link" href="{{ r.url | relative_url }}">
                    {{ r.recipe_title }}
                  </a>
                </h4>
              </div>

              {% if r.recipe_subtitle %}
                <p class="recipe-card-subtitle mb-1">{{ r.recipe_subtitle }}</p>
              {% endif %}

              {% if r.recipe_tested == false %}
                <span class="badge bg-warning text-dark mb-2">Recette non testÃ©e</span>
              {% endif %}

              <div class="recipe-card-actions">
                <a class="btn btn-sm btn-primary" href="{{ r.url | relative_url }}">{{ cta }}</a>
              </div>

              <div class="recipe-badges-wrap">
                {% if r.tags %}
                  <ul class="recipe-badges-line badges-tags" aria-label="Tags fonctionnels">
                    {% for tag in r.tags %}
                      {% unless hidden_tags contains tag %}
                        {% case tag %}
                          {% when "tres-proteine" %}
                            <li><a class="badge-link-card" href="{{ '/tags/tres-proteine/' | relative_url }}" title="TrÃ¨s protÃ©inÃ©">ğŸ’ª</a></li>
                          {% when "riche-en-fibres" %}
                            <li><a class="badge-link-card" href="{{ '/tags/riche-en-fibres/' | relative_url }}" title="Riche en fibres">ğŸ’©</a></li>
                          {% when "rapide" %}
                            <li><a class="badge-link-card" href="{{ '/tags/rapide/' | relative_url }}" title="Rapide">â±ï¸</a></li>
                          {% when "congelable" %}
                            <li><a class="badge-link-card" href="{{ '/tags/congelable/' | relative_url }}" title="CongÃ©lable">â„ï¸</a></li>
                          {% when "micro-ondable" %}
                            <li><a class="badge-link-card" href="{{ '/tags/micro-ondable/' | relative_url }}" title="Micro-ondable">â™¨ï¸</a></li>
                          {% when "peu-calorique" %}
                            <li><a class="badge-link-card" href="{{ '/tags/peu-calorique/' | relative_url }}" title="Peu calorique">ğŸª¶</a></li>
                          {% when "calorique" %}
                            <li><a class="badge-link-card" href="{{ '/tags/calorique/' | relative_url }}" title="Calorique">ğŸ”¥</a></li>
                          {% when "longue" %}
                            <li><a class="badge-link-card" href="{{ '/tags/longue/' | relative_url }}" title="PrÃ©paration longue">ğŸŒ</a></li>
                          {% when "gout-sucre" %}
                            <li><a class="badge-link-card" href="{{ '/tags/gout-sucre/' | relative_url }}" title="GoÃ»t sucrÃ©">ğŸ¬</a></li>
                        {% endcase %}
                      {% endunless %}
                    {% endfor %}
                  </ul>
                {% endif %}

                {% assign micros = r.badges_nutritionnels | default: "" %}
                {% if micros and micros.size > 0 %}
                  <ul class="recipe-badges-line badges-micro" aria-label="Micronutriments">
                    {% for m in micros %}
                      {% case m %}
                        {% when "omega-3" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/omega-3/' | relative_url }}" title="OmÃ©ga-3">ğŸŸ</a></li>
                        {% when "vitamine-a" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/vitamine-a/' | relative_url }}" title="Vitamine A">ğŸ‘ï¸</a></li>
                        {% when "vitamine-c" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/vitamine-c/' | relative_url }}" title="Vitamine C">ğŸ‹</a></li>
                        {% when "vitamine-d" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/vitamine-d/' | relative_url }}" title="Vitamine D">ğŸŒ¤ï¸</a></li>
                        {% when "vitamine-e" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/vitamine-e/' | relative_url }}" title="Vitamine E">ğŸ›¡ï¸</a></li>
                        {% when "vitamine-k" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/vitamine-k/' | relative_url }}" title="Vitamine K">ğŸ©¸</a></li>
                        {% when "vitamine-b9" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/vitamine-b9/' | relative_url }}" title="Vitamine B9">ğŸŒ±</a></li>
                        {% when "vitamine-b12" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/vitamine-b12/' | relative_url }}" title="Vitamine B12">ğŸ¥©</a></li>
                        {% when "calcium" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/calcium/' | relative_url }}" title="Calcium">ğŸ¦´</a></li>
                        {% when "fer" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/fer/' | relative_url }}" title="Fer">ğŸ§²</a></li>
                        {% when "magnesium" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/magnesium/' | relative_url }}" title="MagnÃ©sium">âš¡</a></li>
                        {% when "potassium" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/potassium/' | relative_url }}" title="Potassium">ğŸŒ</a></li>
                        {% when "zinc" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/zinc/' | relative_url }}" title="Zinc">ğŸ”©</a></li>
                        {% when "selenium" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/selenium/' | relative_url }}" title="SÃ©lÃ©nium">ğŸ§ª</a></li>
                        {% when "iode" %}
                          <li><a class="badge-link-card" href="{{ '/micronutriments/iode/' | relative_url }}" title="Iode">ğŸŒŠ</a></li>
                      {% endcase %}
                    {% endfor %}
                  </ul>
                {% endif %}
              </div>

            </article>
          </div>

        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>

