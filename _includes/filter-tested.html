<!--
==============================================================================
_include/filter-tested.html — Filtre “recettes testées”
==============================================================================

Rôle
- Fournir un bouton toggle “Voir seulement les recettes testées”.
- Masquer / afficher les cartes enveloppées dans .recipe-item selon data-tested.
- Exposer l’état du filtre via document.body.dataset.onlyTested.
- Notifier les autres scripts via l’évènement global "testedFilterChanged".

Contrats / dépendances
- Chaque carte recette DOIT être enveloppée par :
    <div class="recipe-item" data-tested="true|false"> ... </div>
  (contrat fourni par _includes/recipes-index.html).
- L’include peut être rendu avant la liste des recettes :
  => on attend DOMContentLoaded avant de requêter .recipe-item.

Sorties (interfaces JS)
- document.body.dataset.onlyTested : "true" | "false"
- Évènement document "testedFilterChanged" :
    detail: { onlyTested: boolean }

Contrainte UI
- Si aucun wrapper conforme n’est trouvé, le bouton est masqué pour éviter
  une action sans effet.
==============================================================================
-->

<div class="d-flex flex-wrap align-items-center gap-2 mb-3" id="tested-filter">
  <button
    type="button"
    class="btn btn-sm btn-outline-primary"
    id="btn-only-tested"
    aria-pressed="false"
  >
    Voir seulement les recettes testées
  </button>
</div>

<script>
/**
 * Filtre “recettes testées”.
 *
 * Contrat :
 * - S’appuie sur .recipe-item[data-tested="true|false"] rendu par recipes-index.html.
 *
 * Interfaces exposées :
 * - document.body.dataset.onlyTested ("true" | "false") pour lecture par d’autres scripts.
 * - Évènement "testedFilterChanged" (CustomEvent) émis à chaque bascule.
 *
 * Timing :
 * - DOMContentLoaded est requis car l’include peut être placé avant les cartes.
 */
document.addEventListener("DOMContentLoaded", function () {
  const btn = document.getElementById("btn-only-tested");
  if (!btn) return;

  const items = document.querySelectorAll(".recipe-item[data-tested]");

  // Garde-fou : si le markup contractuel n’existe pas, on neutralise l’UI.
  if (items.length === 0) {
    btn.style.display = "none";
    return;
  }

  /**
   * Publie l’état courant du filtre :
   * - dataset pour consommation passive
   * - évènement pour recalculs actifs (ex : random-pick)
   */
  function notifyChange(onlyTested) {
    document.body.dataset.onlyTested = onlyTested ? "true" : "false";

    document.dispatchEvent(
      new CustomEvent("testedFilterChanged", {
        detail: { onlyTested: onlyTested }
      })
    );
  }

  /**
   * Applique le filtrage à toutes les cartes :
   * - cache uniquement les recettes non testées si onlyTested=true
   * - met à jour l’état ARIA et les classes Bootstrap du bouton
   */
  function applyFilter(onlyTested) {
    items.forEach((el) => {
      const isTested = el.getAttribute("data-tested") === "true";
      el.style.display = (onlyTested && !isTested) ? "none" : "";
    });

    btn.setAttribute("aria-pressed", String(onlyTested));
    btn.classList.toggle("btn-primary", onlyTested);
    btn.classList.toggle("btn-outline-primary", !onlyTested);
    btn.textContent = onlyTested
      ? "Voir toutes les recettes"
      : "Voir seulement les recettes testées";

    notifyChange(onlyTested);
  }

  // État initial : aucune restriction (toutes les recettes visibles).
  let onlyTested = false;
  applyFilter(onlyTested);

  btn.addEventListener("click", function () {
    onlyTested = !onlyTested;
    applyFilter(onlyTested);
  });
});
</script>

