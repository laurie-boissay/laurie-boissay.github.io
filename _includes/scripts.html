<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous">
</script>

<script>
  const SITE_BASEURL = "{{ site.baseurl }}";

  function closeCollapseById(id) {
    const el = document.getElementById(id);
    if (!el || !window.bootstrap) return;

    const inst =
      window.bootstrap.Collapse.getInstance(el) ||
      new window.bootstrap.Collapse(el, { toggle: false });

    inst.hide();
  }

  function fixAnchorOffset(hash) {
    const h = hash || location.hash;
    if (!h) return;

    let target;
    try { target = document.querySelector(h); }
    catch (e) { return; }
    if (!target) return;

    const nav = document.getElementById("navigation");
    const navH = nav ? nav.getBoundingClientRect().height : 0;

    const y = target.getBoundingClientRect().top + window.scrollY - navH - 12;

    // Neutraliser temporairement le smooth scroll
    const html = document.documentElement;
    const prev = html.style.scrollBehavior;
    html.style.scrollBehavior = "auto";

    window.scrollTo(0, y);

    html.style.scrollBehavior = prev || "";
  }

  function isHomePage() {
    const path = location.pathname.replace(/\/+$/, "");
    const base = (SITE_BASEURL || "").replace(/\/+$/, "");

    const home1 = (base + "/").replace(/\/+$/, "");
    const home2 = (base + "/index.html").replace(/\/+$/, "");

    return path === home1 || path === home2 || path === base;
  }

  // Fermer menu mobile après clic sur une catégorie + scroll propre (index)
  document.addEventListener("click", function (e) {
    const chip = e.target.closest(".recipes-group-chip");
    if (!chip) return;

    const href = chip.getAttribute("href") || "";
    const hashIndex = href.indexOf("#");
    if (hashIndex === -1) return;

    const hash = href.slice(hashIndex);

    // Fermer le menu burger (mobile)
    closeCollapseById("navbarSupportedContent");

    if (isHomePage()) {
      e.preventDefault();
      history.pushState(null, "", hash);

      setTimeout(() => fixAnchorOffset(hash), 0);
      setTimeout(() => fixAnchorOffset(hash), 120);
      setTimeout(() => fixAnchorOffset(hash), 260);
    }
  });

  // Corriger l'offset quand on arrive sur /#groupe depuis une autre page
  window.addEventListener("load", () => {
    setTimeout(() => fixAnchorOffset(location.hash), 0);
    setTimeout(() => fixAnchorOffset(location.hash), 180);
    setTimeout(() => fixAnchorOffset(location.hash), 420);
  });

  window.addEventListener("hashchange", () => {
    setTimeout(() => fixAnchorOffset(location.hash), 120);
    setTimeout(() => fixAnchorOffset(location.hash), 260);
  });

  // ===== IMPORTANT : empêcher le scroll de la page derrière quand le dropdown est ouvert (mobile)
  function isMobileNav() {
    return window.matchMedia("(max-width: 991.98px)").matches;
  }

  function lockBodyScroll(lock) {
    if (!isMobileNav()) return;
    document.body.style.overflow = lock ? "hidden" : "";
    document.body.style.touchAction = lock ? "none" : "";
  }

  document.addEventListener("shown.bs.dropdown", function (e) {
    if (e.target && e.target.id === "recipesDropdown") lockBodyScroll(true);
  });

  document.addEventListener("hidden.bs.dropdown", function (e) {
    if (e.target && e.target.id === "recipesDropdown") lockBodyScroll(false);
  });
</script>
