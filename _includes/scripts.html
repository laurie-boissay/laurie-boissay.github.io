<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous">
</script>

<script>
  // Baseurl Jekyll ("" si site à la racine, sinon "/mon-repo")
  const SITE_BASEURL = "{{ site.baseurl }}";

  function closeCollapseById(id) {
    const el = document.getElementById(id);
    if (!el || !window.bootstrap) return;

    const inst =
      window.bootstrap.Collapse.getInstance(el) ||
      new window.bootstrap.Collapse(el, { toggle: false });

    inst.hide();
  }

  function fixAnchorOffset(hash) {
    const h = hash || location.hash;
    if (!h) return;

    let target;
    try { target = document.querySelector(h); }
    catch (e) { return; }
    if (!target) return;

    const nav = document.getElementById("navigation");
    const navH = nav ? nav.getBoundingClientRect().height : 0;

    const y = target.getBoundingClientRect().top + window.scrollY - navH - 12;

    // IMPORTANT : neutraliser temporairement le smooth scroll
    const html = document.documentElement;
    const prev = html.style.scrollBehavior;
    html.style.scrollBehavior = "auto";

    window.scrollTo(0, y);

    // Restore
    html.style.scrollBehavior = prev || "";
  }

  function isHomePage() {
    const path = location.pathname.replace(/\/+$/, "");
    const base = (SITE_BASEURL || "").replace(/\/+$/, "");

    const home1 = (base + "/").replace(/\/+$/, "");
    const home2 = (base + "/index.html").replace(/\/+$/, "");

    return path === home1 || path === home2 || path === base;
  }

  function onRecipeGroupClick(e) {
    const chip = e.target.closest(".recipes-group-chip");
    if (!chip) return;

    const href = chip.getAttribute("href") || "";
    const hashIndex = href.indexOf("#");
    if (hashIndex === -1) return;

    const hash = href.slice(hashIndex); // "#plats-a-base-de-poissons"

    // Fermer les panneaux (utile mobile)
    closeCollapseById("recipesGroupsCollapse");
    closeCollapseById("navbarSupportedContent");

    // Si on est déjà sur l'index : empêcher le scroll natif et scroll proprement
    if (isHomePage()) {
      e.preventDefault();

      // Met à jour l'URL sans scroll natif
      history.pushState(null, "", hash);

      // Laisse le temps aux collapses/bootstrap de se fermer puis corrige l'offset
      setTimeout(() => fixAnchorOffset(hash), 0);
      setTimeout(() => fixAnchorOffset(hash), 120);
      setTimeout(() => fixAnchorOffset(hash), 260);
    }
    // Sinon : on laisse la navigation normale vers /#hash
    // et on corrige au load.
  }

  document.addEventListener("click", onRecipeGroupClick);

  // Corriger l'offset quand on arrive sur /#groupe (navigation depuis une autre page)
  window.addEventListener("load", () => {
    setTimeout(() => fixAnchorOffset(location.hash), 0);
    setTimeout(() => fixAnchorOffset(location.hash), 180);
    setTimeout(() => fixAnchorOffset(location.hash), 420);
  });

  // Back/forward
  window.addEventListener("hashchange", () => {
    setTimeout(() => fixAnchorOffset(location.hash), 120);
    setTimeout(() => fixAnchorOffset(location.hash), 260);
  });
</script>
