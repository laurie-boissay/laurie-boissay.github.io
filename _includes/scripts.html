<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous">
</script>

<script>
  // Baseurl Jekyll ("" si site à la racine, sinon "/mon-repo")
  const SITE_BASEURL = "{{ site.baseurl }}";

  function closeCollapseById(id) {
    const el = document.getElementById(id);
    if (!el || !window.bootstrap) return;

    const inst =
      window.bootstrap.Collapse.getInstance(el) ||
      new window.bootstrap.Collapse(el, { toggle: false });

    inst.hide();
  }

  function fixAnchorOffset(hash) {
    const h = hash || location.hash;
    if (!h) return;

    let target;
    try { target = document.querySelector(h); }
    catch (e) { return; }
    if (!target) return;

    const nav = document.getElementById("navigation");
    const navH = nav ? nav.getBoundingClientRect().height : 0;

    const y = target.getBoundingClientRect().top + window.scrollY - navH - 12;
    window.scrollTo({ top: y, behavior: "auto" });
  }

  function onRecipeGroupClick(e) {
    const chip = e.target.closest(".recipes-group-chip");
    if (!chip) return;

    const href = chip.getAttribute("href") || "";
    const hashIndex = href.indexOf("#");
    if (hashIndex === -1) return;

    const hash = href.slice(hashIndex); // "#plats-a-base-de-poissons"

    // Fermer les panneaux (utile mobile)
    closeCollapseById("recipesGroupsCollapse");
    closeCollapseById("navbarSupportedContent");

    // Si on est déjà sur l'index : on empêche le scroll natif et on scroll proprement
    const path = location.pathname.replace(/\/+$/, "");
    const base = (SITE_BASEURL || "").replace(/\/+$/, "");
    const home1 = (base + "/").replace(/\/+$/, "");
    const home2 = (base + "/index.html").replace(/\/+$/, "");

    const isHome =
      path === home1 ||
      path === home2 ||
      path === base; // cas racine

    if (isHome) {
      e.preventDefault();

      // Met à jour l'URL sans déclencher le scroll natif
      history.pushState(null, "", hash);

      // On scroll après que Bootstrap ait fini ses animations/collapses
      setTimeout(() => fixAnchorOffset(hash), 0);
      setTimeout(() => fixAnchorOffset(hash), 80);
      setTimeout(() => fixAnchorOffset(hash), 200);
      return;
    }

    // Sinon (on vient d'une autre page), on laisse la navigation se faire
    // et on corrige au load.
  }

  document.addEventListener("click", onRecipeGroupClick);

  // Corriger l'offset quand on arrive sur /#groupe (navigation depuis une autre page)
  window.addEventListener("load", () => {
    setTimeout(() => fixAnchorOffset(location.hash), 0);
    setTimeout(() => fixAnchorOffset(location.hash), 150);
    setTimeout(() => fixAnchorOffset(location.hash), 350);
  });

  // Si quelqu'un change le hash via back/forward
  window.addEventListener("hashchange", () => {
    setTimeout(() => fixAnchorOffset(location.hash), 80);
    setTimeout(() => fixAnchorOffset(location.hash), 200);
  });
</script>
