<!DOCTYPE html>
<html lang="fr">
<head>
  {% include head.html %}

  {%- comment -%}
    =========================================================
    LAYOUT â€” RECETTE (STRUCTURANT)
    =========================================================
    RÃ´le :
    - Afficher une fiche recette Ã  partir du front-matter (Option 2 â€œdata-onlyâ€).
    - Conserver le support des anciennes recettes avec contenu HTML (fallback).

    EntrÃ©es (front-matter) â€” data-only :
    - recipe_title, recipe_subtitle, recipe_group, recipe_tested
    - tags, badges_nutritionnels
    - image, image_alt
    - calories, proteines, glucides_nets (obligatoires selon tes rÃ¨gles)
    - nutrition.* (lipides, glucides, fibres, fructose) optionnel mais recommandÃ©
    - ingredients (liste ; supporte string OU objet {label, link})
    - steps (liste)
    - notes_low_carb (liste ; supporte :
        1) string
        2) map YAML (si ":" non quotÃ©)
        3) string â€œsÃ©rialisÃ©eâ€ type {"clÃ©"=>"valeur"})

    Contrats :
    - Tableau nutritionnel Ã  2 colonnes (Nutriment | Valeur).
    - Ligne â€œGlucides netsâ€ toujours affichÃ©e si fournie.
    - Liens internes recettes : /recettes/...html avec relative_url.

    Important :
    - head.html gÃ¨re dÃ©jÃ  page.extra_head (ne pas le dupliquer ici).
    =========================================================
  {%- endcomment -%}
</head>

<body class="container-fluid recipe{% if page.body_id %} {{ page.body_id }}{% endif %}">
 
   {% include navbar.html %}

  <main class="site-main">
    <div class="site-container">

      {% include bandeau-non-teste.html %}

      {%- comment -%}
        Tags techniques / cachÃ©s :
        - low-carb-modere et low-carb-strict sont invisibles en badges.
        - gout-sucre est affichÃ© (ğŸ¬).
      {%- endcomment -%}
      {%- assign hidden_tags = "low-carb-modere,low-carb-strict" | split: "," -%}

      <header class="recipe-head">
        <h1 class="recipe-title">{{ page.recipe_title | default: page.title }}</h1>

        {%- if page.recipe_subtitle and page.recipe_subtitle != "" -%}
          <p class="text-muted mb-2">{{ page.recipe_subtitle }}</p>
        {%- endif -%}

        {%- comment -%}
          Photo optionnelle :
          - relative_url pour compat GitHub Pages.
        {%- endcomment -%}
        {% if page.image %}
          <figure class="recipe-photo">
            <img
              src="{{ page.image | relative_url }}"
              alt="{{ page.image_alt | default: page.recipe_title | default: page.title | escape }}"
              loading="lazy"
            >
          </figure>
        {% endif %}

        {%- comment -%}
          Badges :
          - Ligne 1 : tags fonctionnels (cliquables).
          - Ligne 2 : micronutriments (cliquables).
        {%- endcomment -%}
        <div class="recipe-badges-wrap">

          {% if page.tags %}
            <ul class="recipe-badges-line badges-tags" aria-label="Tags fonctionnels">
              {% for tag in page.tags %}
                {% unless hidden_tags contains tag %}
                  {% case tag %}
                    {% when "tres-proteine" %}
                      <li><a class="badge-link-card" href="{{ '/tags/tres-proteine/' | relative_url }}" title="TrÃ¨s protÃ©inÃ©">ğŸ’ª</a></li>
                    {% when "riche-en-fibres" %}
                      <li><a class="badge-link-card" href="{{ '/tags/riche-en-fibres/' | relative_url }}" title="Riche en fibres">ğŸ’©</a></li>
                    {% when "rapide" %}
                      <li><a class="badge-link-card" href="{{ '/tags/rapide/' | relative_url }}" title="Rapide">â±ï¸</a></li>
                    {% when "congelable" %}
                      <li><a class="badge-link-card" href="{{ '/tags/congelable/' | relative_url }}" title="CongÃ©lable">â„ï¸</a></li>
                    {% when "micro-ondable" %}
                      <li><a class="badge-link-card" href="{{ '/tags/micro-ondable/' | relative_url }}" title="Micro-ondable">â™¨ï¸</a></li>
                    {% when "peu-calorique" %}
                      <li><a class="badge-link-card" href="{{ '/tags/peu-calorique/' | relative_url }}" title="Peu calorique">ğŸª¶</a></li>
                    {% when "calorique" %}
                      <li><a class="badge-link-card" href="{{ '/tags/calorique/' | relative_url }}" title="Calorique">ğŸ”¥</a></li>
                    {% when "longue" %}
                      <li><a class="badge-link-card" href="{{ '/tags/longue/' | relative_url }}" title="PrÃ©paration longue">ğŸŒ</a></li>
                    {% when "gout-sucre" %}
                      <li><a class="badge-link-card" href="{{ '/tags/gout-sucre/' | relative_url }}" title="GoÃ»t sucrÃ©">ğŸ¬</a></li>
                  {% endcase %}
                {% endunless %}
              {% endfor %}
            </ul>
          {% endif %}

          {% assign micros = page.badges_nutritionnels | default: "" %}
          {% if micros and micros.size > 0 %}
            <ul class="recipe-badges-line badges-micro" aria-label="Micronutriments">
              {% for m in micros %}
                {% case m %}
                  {% when "omega-3" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/omega-3/' | relative_url }}" title="OmÃ©ga-3">ğŸŸ</a></li>

                  {% when "vitamine-a" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/vitamine-a/' | relative_url }}" title="Vitamine A">ğŸ‘ï¸</a></li>
                  {% when "vitamine-c" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/vitamine-c/' | relative_url }}" title="Vitamine C">ğŸ‹</a></li>
                  {% when "vitamine-d" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/vitamine-d/' | relative_url }}" title="Vitamine D">ğŸŒ¤ï¸</a></li>
                  {% when "vitamine-e" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/vitamine-e/' | relative_url }}" title="Vitamine E">ğŸ›¡ï¸</a></li>
                  {% when "vitamine-k" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/vitamine-k/' | relative_url }}" title="Vitamine K">ğŸ©¸</a></li>
                  {% when "vitamine-b9" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/vitamine-b9/' | relative_url }}" title="Vitamine B9">ğŸŒ±</a></li>
                  {% when "vitamine-b12" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/vitamine-b12/' | relative_url }}" title="Vitamine B12">ğŸ¥©</a></li>

                  {% when "calcium" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/calcium/' | relative_url }}" title="Calcium">ğŸ¦´</a></li>
                  {% when "fer" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/fer/' | relative_url }}" title="Fer">ğŸ§²</a></li>
                  {% when "magnesium" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/magnesium/' | relative_url }}" title="MagnÃ©sium">âš¡</a></li>
                  {% when "potassium" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/potassium/' | relative_url }}" title="Potassium">ğŸŒ</a></li>
                  {% when "zinc" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/zinc/' | relative_url }}" title="Zinc">ğŸ”©</a></li>
                  {% when "selenium" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/selenium/' | relative_url }}" title="SÃ©lÃ©nium">ğŸ§ª</a></li>
                  {% when "iode" %}
                    <li><a class="badge-link-card" href="{{ '/micronutriments/iode/' | relative_url }}" title="Iode">ğŸŒŠ</a></li>
                {% endcase %}
              {% endfor %}
            </ul>
          {% endif %}

          <details class="badges-legend">
            <summary>LÃ©gende des badges</summary>
            <ul>
              <li>ğŸ’ª TrÃ¨s protÃ©inÃ©</li>
              <li>ğŸ’© Riche en fibres</li>
              <li>â±ï¸ Rapide Ã  prÃ©parer</li>
              <li>â„ï¸ CongÃ©lable</li>
              <li>â™¨ï¸ Micro-ondable</li>
              <li>ğŸª¶ Peu calorique</li>
              <li>ğŸ”¥ Calorique</li>
              <li>ğŸŒ PrÃ©paration longue / temps passif important</li>
              <li>ğŸ¬ GoÃ»t sucrÃ©</li>
              <li>ğŸŸ OmÃ©ga-3</li>
              <li>ğŸ‘ï¸ Vitamine A</li>
              <li>ğŸ‹ Vitamine C</li>
              <li>ğŸŒ¤ï¸ Vitamine D</li>
              <li>ğŸ›¡ï¸ Vitamine E</li>
              <li>ğŸ©¸ Vitamine K</li>
              <li>ğŸŒ± Vitamine B9</li>
              <li>ğŸ¥© Vitamine B12</li>
              <li>ğŸ¦´ Calcium</li>
              <li>ğŸ§² Fer</li>
              <li>âš¡ MagnÃ©sium</li>
              <li>ğŸŒ Potassium</li>
              <li>ğŸ”© Zinc</li>
              <li>ğŸ§ª SÃ©lÃ©nium</li>
              <li>ğŸŒŠ Iode</li>
            </ul>
          </details>

        </div>
      </header>

      {%- comment -%}
        Mode data-only :
        - Si ingredients/steps/nutrition existent, on gÃ©nÃ¨re lâ€™affichage ici.
        - Sinon, fallback : on rend le contenu HTML (anciennes recettes).
      {%- endcomment -%}
      <div class="content-surface recipe-surface">

        {% if page.ingredients or page.steps or page.calories or page.proteines or page.glucides_nets %}

          {%- comment -%}
            IngrÃ©dients :
            - Supporte deux formes :
              1) string : "200 g de skyr"
              2) objet : {label: "...", link: "/recettes/...html"}
          {%- endcomment -%}
          {% if page.ingredients %}
            <h2>IngrÃ©dients</h2>
            <ul>
              {% for i in page.ingredients %}
                <li>
                  {% if i.label and i.link %}
                    <a href="{{ i.link | relative_url }}">{{ i.label }}</a>
                  {% else %}
                    {{ i }}
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% endif %}

          {% if page.steps %}
            <h2>PrÃ©paration</h2>
            <ol>
              {% for s in page.steps %}
                <li>{{ s }}</li>
              {% endfor %}
            </ol>
          {% endif %}

          {%- comment -%}
            Nutrition :
            - Tableau 2 colonnes.
            - â€œGlucides netsâ€ affichÃ© si la recette fournit page.glucides_nets.
          {%- endcomment -%}
          <h2>Informations nutritionnelles</h2>
          <p>Valeurs estimÃ©es par portion.</p>

          <div class="table-responsive">
            <table class="table table-striped">
              <tbody>
                {% if page.calories %}
                  <tr><th scope="row">Ã‰nergie</th><td>{{ page.calories }} kcal</td></tr>
                {% endif %}
                {% if page.proteines %}
                  <tr><th scope="row">ProtÃ©ines</th><td>{{ page.proteines }} g</td></tr>
                {% endif %}
                {% if page.nutrition and page.nutrition.lipides %}
                  <tr><th scope="row">Lipides</th><td>{{ page.nutrition.lipides }} g</td></tr>
                {% endif %}
                {% if page.nutrition and page.nutrition.glucides %}
                  <tr><th scope="row">Glucides totaux</th><td>{{ page.nutrition.glucides }} g</td></tr>
                {% endif %}
                {% if page.nutrition and page.nutrition.fructose != nil %}
                  <tr><th scope="row">dont fructose</th><td>{{ page.nutrition.fructose }} g</td></tr>
                {% endif %}
                {% if page.nutrition and page.nutrition.fibres %}
                  <tr><th scope="row">Fibres</th><td>{{ page.nutrition.fibres }} g</td></tr>
                {% endif %}
                {% if page.glucides_nets %}
                  <tr><th scope="row">Glucides nets</th><td>{{ page.glucides_nets }} g</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          {%- comment -%}
            Notes low carb â€” rendu robuste.

            Objectif :
            - Corriger lâ€™affichage "{"clÃ©"=>"valeur"}" sans refaire les recettes.

            Cas supportÃ©s :
            1) String propre :
               - "TrÃ¨s protÃ©inÃ© : ~40 g par portion."
            2) Map YAML (si ":" non quotÃ©) :
               - TrÃ¨s protÃ©inÃ© : ~40 g par portion.
            3) String dÃ©jÃ  â€œsÃ©rialisÃ©eâ€ (copiÃ©e depuis un rendu) :
               - {"TrÃ¨s protÃ©inÃ©"=>"~40 g par portion."}
          {%- endcomment -%}
          {% if page.notes_low_carb %}
            <h2>Notes low carb</h2>
            <ul>
              {% for n in page.notes_low_carb %}

                {% if n.keys %}
                  {%- comment -%} Cas 2 : hash YAML { "Titre" => "texte" } {%- endcomment -%}
                  {% for kv in n %}
                    <li><strong>{{ kv[0] }}</strong> : {{ kv[1] }}</li>
                  {% endfor %}

                {% else %}
                  {%- assign raw = n | strip -%}

                  {% if raw contains '"=>"' %}
                    {%- comment -%}
                      Cas 3 : string du type {"Titre"=>"texte"}.
                      Nettoyage simple :
                      - suppression des accolades
                      - remplacement du sÃ©parateur Ruby "=>" en " : "
                      - suppression des guillemets rÃ©siduels
                    {%- endcomment -%}
                    {%- assign pretty = raw
                      | replace: '{', ''
                      | replace: '}', ''
                      | replace: '"=>"', ' : '
                      | replace: '"', ''
                    -%}
                    <li>{{ pretty }}</li>
                  {% else %}
                    {%- comment -%} Cas 1 : string classique {%- endcomment -%}
                    <li>{{ n }}</li>
                  {% endif %}

                {% endif %}

              {% endfor %}
            </ul>
          {% endif %}

        {% else %}
          {{ content }}
        {% endif %}

      </div>

      {% include footer.html %}

    </div>
  </main>

  {% include scripts.html %}
</body>
</html>

