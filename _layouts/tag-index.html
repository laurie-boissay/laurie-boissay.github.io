---
layout: page
---

{%- comment -%}
==============================================================================
tag-index.html — Page d’index filtrée (tags fonctionnels / micronutriments)
==============================================================================

Rôle
- Afficher une liste de recettes filtrée par :
  • tag fonctionnel (page.filter_type = "tag")
  • micronutriment (page.filter_type = "micro")

Entrées (front-matter)
- filter_type : "tag" | "micro"
- filter_id   : identifiant du tag (ex: "rapide") ou du micronutriment (ex: "omega-3")

Contrats / dépendances
- random-pick.html :
  • doit être rendu AVANT la navigation par badges (contrainte UX).
  • lit document.body.dataset.filterType / filterId : ces attributs doivent être posés
    immédiatement (pas de dépendance à DOMContentLoaded).
- recipes-index.html :
  • fournit le marquage <div class="recipe-item" data-tested="true|false"> utilisé
    par le filtre “recettes testées”.
- Données :
  • _data/tags_fonctionnels.yml : descriptions des tags fonctionnels.
  • _data/micronutriments.yml   : fiches micronutriments (rôles, apports, sources, etc.).

Contraintes d’affichage
- Le filtre “recettes testées” n’est affiché que s’il existe au moins une recette
  non testée dans la sélection (évite un contrôle inutile).
==============================================================================
{%- endcomment -%}

<section class="site-container" id="tag-index">

  {%- comment -%}
    Paramètres de filtre exposés au JS (random pick).
    Le script consomme dataset.* dès le chargement : pas de temporisation.
  {%- endcomment -%}
  <script>
    document.body.dataset.filterType = "{{ page.filter_type | escape }}";
    document.body.dataset.filterId   = "{{ page.filter_id   | escape }}";
  </script>

  {%- comment -%}
    Random pick :
    - placé avant la navigation (contrainte UX).
    - hide_links évite la redondance avec la navigation par badges de cette page.
  {%- endcomment -%}
  {% include random-pick.html hide_links=true %}

  {%- comment -%}
    Navigation transversale (badges tags + micronutriments).
  {%- endcomment -%}
  {% include nav-badges.html %}

  {%- assign hidden_tags = "low-carb-modere,low-carb-strict,gout-sucre" | split: "," -%}
  {%- assign recipes = site.pages | where: "layout", "recipe" -%}
  {%- assign filtered = "" | split: "" -%}

  {%- comment -%}
    Filtrage :
    - mode "tag"  : r.tags contient page.filter_id
    - mode "micro": r.badges_nutritionnels contient page.filter_id
  {%- endcomment -%}
  {%- for r in recipes -%}
    {%- if page.filter_type == "tag" and page.filter_id and r.tags contains page.filter_id -%}
      {%- assign filtered = filtered | push: r -%}
    {%- elsif page.filter_type == "micro" and page.filter_id and r.badges_nutritionnels contains page.filter_id -%}
      {%- assign filtered = filtered | push: r -%}
    {%- endif -%}
  {%- endfor -%}

  {%- assign tested_count = 0 -%}
  {%- for r in filtered -%}
    {%- if r.recipe_tested == true -%}
      {%- assign tested_count = tested_count | plus: 1 -%}
    {%- endif -%}
  {%- endfor -%}

  <p class="small text-muted mb-2">
    <strong>{{ filtered.size }}</strong> recette(s).
    <span class="ms-2">Testée(s) : <strong>{{ tested_count }}</strong>.</span>
  </p>

  {%- comment -%}
    Filtre “recettes testées” :
    - affiché uniquement si la sélection contient au moins une recette non testée.
    - le comportement JS s’appuie sur data-tested rendu par recipes-index.html.
  {%- endcomment -%}
  {%- if filtered.size > tested_count -%}
    {% include filter-tested.html %}
  {%- endif -%}

  {%- comment -%}
    Bloc descriptif :
    - tag : contenu issu de _data/tags_fonctionnels
    - micro : contenu issu de _data/micronutriments
    Le bloc n’est rendu que si l’entrée correspondante existe (fail-safe).
  {%- endcomment -%}
  {%- if page.filter_type == "tag" and page.filter_id -%}
    {%- assign taginfo = site.data.tags_fonctionnels[page.filter_id] -%}
    {%- if taginfo -%}
      <section class="micro-desc">
        <h2>{{ taginfo.titre }}</h2>
        <p>{{ taginfo.signification }}</p>

        {%- if taginfo.criteres -%}
          <h3>Critères d’attribution</h3>
          <ul>
            {%- for c in taginfo.criteres -%}<li>{{ c }}</li>{%- endfor -%}
          </ul>
        {%- endif -%}
      </section>
    {%- endif -%}
  {%- endif -%}

  {%- if page.filter_type == "micro" and page.filter_id -%}
    {%- assign micro = site.data.micronutriments[page.filter_id] -%}
    {%- if micro -%}
      <section class="micro-desc">
        <h2>{{ micro.titre }}</h2>
        <p>{{ micro.resume }}</p>

        <h3>À quoi ça sert ?</h3>
        <ul>{% for r in micro.roles %}<li>{{ r }}</li>{% endfor %}</ul>

        <h3>Apports recommandés</h3>
        <p><strong>Adulte :</strong> {{ micro.apports.adulte.cible }}</p>

        <h3>Sources alimentaires</h3>
        <ul>{% for f in micro.ou_en_trouver %}<li>{{ f }}</li>{% endfor %}</ul>

        <h3>Signes de carence</h3>
        <p>{{ micro.carence.signes }}</p>
      </section>
    {%- endif -%}
  {%- endif -%}

  {%- comment -%}
    Regroupement :
    - group_by sur recipe_group
    - exclusion des groupes vides (évite des sections sans titre).
    Le rendu final est délégué à recipes-index.html (source de vérité du markup).
  {%- endcomment -%}
  {%- assign grouped_raw = filtered | group_by: "recipe_group" -%}
  {%- assign grouped = "" | split: "" -%}

  {%- for g in grouped_raw -%}
    {%- if g.name and g.name != "" -%}
      {%- assign grouped = grouped | push: g -%}
    {%- endif -%}
  {%- endfor -%}

  {% include recipes-index.html grouped=grouped hidden_tags=hidden_tags %}

</section>

