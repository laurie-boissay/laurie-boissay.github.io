---
layout: page
---

{%- comment -%}
==============================================================================
tag-index.html ‚Äî Page d‚Äôindex filtr√©e (tags fonctionnels / micronutriments)
==============================================================================

R√¥le
- Afficher une liste de recettes filtr√©e par :
  ‚Ä¢ tag fonctionnel (page.filter_type = "tag")
  ‚Ä¢ micronutriment (page.filter_type = "micro")

Entr√©es (front-matter)
- filter_type : "tag" | "micro"
- filter_id   : identifiant du tag (ex: "rapide") ou du micronutriment (ex: "omega-3")

Contrats / d√©pendances
- random-pick.html :
  ‚Ä¢ doit √™tre rendu AVANT la navigation par badges (contrainte UX).
  ‚Ä¢ lit document.body.dataset.filterType / filterId : ces attributs doivent √™tre pos√©s
    imm√©diatement (pas de d√©pendance √† DOMContentLoaded).
- recipes-index.html :
  ‚Ä¢ fournit le marquage <div class="recipe-item" data-tested="true|false"> utilis√©
    par le filtre ‚Äúrecettes test√©es‚Äù.
  ‚Ä¢ interpr√®te le param√®tre hidden_tags pour masquer UNIQUEMENT certains tags techniques
    dans l‚ÄôUI des cartes (affichage des emojis).
- Donn√©es :
  ‚Ä¢ _data/tags_fonctionnels.yml : descriptions des tags fonctionnels.
  ‚Ä¢ _data/micronutriments.yml   : fiches micronutriments (r√¥les, apports, sources, etc.).

Contraintes d‚Äôaffichage
- Le filtre ‚Äúrecettes test√©es‚Äù n‚Äôest affich√© que s‚Äôil existe au moins une recette
  non test√©e dans la s√©lection (√©vite un contr√¥le inutile).

Note importante (gout-sucre)
- Le tag "gout-sucre" DOIT √™tre affich√© sur les cartes (emoji üç¨).
- Son exclusion du tirage al√©atoire se g√®re dans la logique du random pick (JS),
  pas via hidden_tags (qui ne fait que masquer l‚Äôaffichage).
==============================================================================
{%- endcomment -%}

<section class="site-container" id="tag-index">

  {%- comment -%}
    Param√®tres de filtre expos√©s au JS (random pick).
    Le script consomme dataset.* d√®s le chargement : pas de temporisation.
  {%- endcomment -%}
  <script>
    document.body.dataset.filterType = "{{ page.filter_type | escape }}";
    document.body.dataset.filterId   = "{{ page.filter_id   | escape }}";
  </script>

  {%- comment -%}
    Random pick :
    - plac√© avant la navigation (contrainte UX).
    - hide_links √©vite la redondance avec la navigation par badges de cette page.
  {%- endcomment -%}
  {% include random-pick.html hide_links=true %}

  {%- comment -%}
    Navigation transversale (badges tags + micronutriments).
  {%- endcomment -%}
  {% include nav-badges.html %}

  {%- comment -%}
    Tags techniques masqu√©s dans l‚ÄôUI des cartes :
    - low-carb-modere / low-carb-strict : tags de classification, non affich√©s en badges.
  {%- endcomment -%}
  {%- assign hidden_tags = "low-carb-modere,low-carb-strict" | split: "," -%}

  {%- assign recipes = site.pages | where: "layout", "recipe" -%}
  {%- assign filtered = "" | split: "" -%}

  {%- comment -%}
    Filtrage :
    - mode "tag"  : r.tags contient page.filter_id
    - mode "micro": r.badges_nutritionnels contient page.filter_id
  {%- endcomment -%}
  {%- for r in recipes -%}
    {%- if page.filter_type == "tag" and page.filter_id and r.tags contains page.filter_id -%}
      {%- assign filtered = filtered | push: r -%}
    {%- elsif page.filter_type == "micro" and page.filter_id and r.badges_nutritionnels contains page.filter_id -%}
      {%- assign filtered = filtered | push: r -%}
    {%- endif -%}
  {%- endfor -%}

  {%- assign tested_count = 0 -%}
  {%- for r in filtered -%}
    {%- if r.recipe_tested == true -%}
      {%- assign tested_count = tested_count | plus: 1 -%}
    {%- endif -%}
  {%- endfor -%}

  <p class="small text-muted mb-2">
    <strong>{{ filtered.size }}</strong> recette(s).
    <span class="ms-2">Test√©e(s) : <strong>{{ tested_count }}</strong>.</span>
  </p>

  {%- comment -%}
    Filtre ‚Äúrecettes test√©es‚Äù :
    - affich√© uniquement si la s√©lection contient au moins une recette non test√©e.
    - le comportement JS s‚Äôappuie sur data-tested rendu par recipes-index.html.
  {%- endcomment -%}
  {%- if filtered.size > tested_count -%}
    {% include filter-tested.html %}
  {%- endif -%}

  {%- comment -%}
    Bloc descriptif :
    - tag : contenu issu de _data/tags_fonctionnels
    - micro : contenu issu de _data/micronutriments
    Le bloc n‚Äôest rendu que si l‚Äôentr√©e correspondante existe (fail-safe).
  {%- endcomment -%}
  {%- if page.filter_type == "tag" and page.filter_id -%}
    {%- assign taginfo = site.data.tags_fonctionnels[page.filter_id] -%}
    {%- if taginfo -%}
      <section class="micro-desc">
        <h2>{{ taginfo.titre }}</h2>
        <p>{{ taginfo.signification }}</p>

        {%- if taginfo.criteres -%}
          <h3>Crit√®res d‚Äôattribution</h3>
          <ul>
            {%- for c in taginfo.criteres -%}<li>{{ c }}</li>{%- endfor -%}
          </ul>
        {%- endif -%}
      </section>
    {%- endif -%}
  {%- endif -%}

  {%- if page.filter_type == "micro" and page.filter_id -%}
    {%- assign micro = site.data.micronutriments[page.filter_id] -%}
    {%- if micro -%}
      <section class="micro-desc">
        <h2>{{ micro.titre }}</h2>
        <p>{{ micro.resume }}</p>

        <h3>√Ä quoi √ßa sert ?</h3>
        <ul>{% for r in micro.roles %}<li>{{ r }}</li>{% endfor %}</ul>

        <h3>Apports recommand√©s</h3>
        <p><strong>Adulte :</strong> {{ micro.apports.adulte.cible }}</p>

        <h3>Sources alimentaires</h3>
        <ul>{% for f in micro.ou_en_trouver %}<li>{{ f }}</li>{% endfor %}</ul>

        <h3>Signes de carence</h3>
        <p>{{ micro.carence.signes }}</p>
      </section>
    {%- endif -%}
  {%- endif -%}

  {%- comment -%}
    Regroupement :
    - group_by sur recipe_group
    - exclusion des groupes vides (√©vite des sections sans titre).
    Le rendu final est d√©l√©gu√© √† recipes-index.html (source de v√©rit√© du markup).
  {%- endcomment -%}
  {%- assign grouped_raw = filtered | group_by: "recipe_group" -%}
  {%- assign grouped = "" | split: "" -%}

  {%- for g in grouped_raw -%}
    {%- if g.name and g.name != "" -%}
      {%- assign grouped = grouped | push: g -%}
    {%- endif -%}
  {%- endfor -%}

  {% include recipes-index.html grouped=grouped hidden_tags=hidden_tags %}

</section>

