---
layout: page
---

{%- comment -%}
  tag-index.html
  =============

  Page “index filtré” (tags fonctionnels / micronutriments)

  Objectif (UX) :
  - Sur ces pages, le bloc "Random pick" doit apparaître AU-DESSUS des 2 lignes de badges cliquables.

  Paramètres attendus dans la page :
  - page.filter_type : "tag" ou "micro"
  - page.filter_id   : ID technique (ex: "selenium", "tres-proteine")

  Notes techniques :
  - Le JS du random pick lit document.body.dataset.filterType / filterId.
  - On renseigne ces attributs le plus tôt possible (sans attendre DOMContentLoaded),
    pour éviter tout effet d’ordre d’exécution si d’autres scripts changent.

  Ajout : filtre “Seulement les recettes testées”
  ----------------------------------------------
  Comportement :
  - Par défaut : afficher toutes les recettes filtrées (tag ou micronutriment)
  - Au clic : masquer les recettes non testées (recipe_tested != true)

  IMPORTANT :
  - Le JS filtre des éléments HTML qui doivent exister dans le DOM.
  - Il faut donc que _includes/recipes-index.html enveloppe chaque carte recette avec :
      <div class="recipe-item" data-tested="true|false"> ... </div>
{%- endcomment -%}

<section class="site-container" id="tag-index">

  {%- comment -%}
    Initialise immédiatement le filtre sur <body> pour que le random pick puisse le lire.
    (Le <body> existe déjà à ce stade du parsing.)
  {%- endcomment -%}
  <script>
    // Filtre du tirage aléatoire : utilisé par _includes/random-pick.html
    document.body.dataset.filterType = "{{ page.filter_type | escape }}";
    document.body.dataset.filterId = "{{ page.filter_id | escape }}";
  </script>

  {%- comment -%}
    ✅ Random pick sur page badges — POSITIONNÉ AVANT la nav des badges
    - hide_links=true : on masque les liens fixes internes du random pick
      (doublon avec la barre nav-badges juste en dessous).
    - Le filtre est appliqué via document.body.dataset.*
  {%- endcomment -%}
  {% include random-pick.html hide_links=true %}

  {%- comment -%}
    Barre de navigation par badges (2 lignes cliquables)
    - Factorisée dans un include pour éviter la duplication.
  {%- endcomment -%}
  {% include nav-badges.html %}

  {%- comment -%}
    ✅ UX demandé :
    - Compteur + bouton JUSTE SOUS les 2 lignes de tags
    - On calcule filtered + tested_count ici,
      puis on affiche compteur + include du filtre.
  {%- endcomment -%}

  {%- comment -%}
    Tags techniques masqués dans l’affichage des badges sur les cartes.
    (Ces tags restent utilisables ailleurs, mais ne doivent pas polluer l’UI des cartes.)
  {%- endcomment -%}
  {%- assign hidden_tags = "low-carb-modere,low-carb-strict,gout-sucre" | split: "," -%}

  {%- comment -%}
    Construction de la liste filtrée :
    - Si page.filter_type == "tag"  : r.tags contient page.filter_id
    - Si page.filter_type == "micro": r.badges_nutritionnels contient page.filter_id
  {%- endcomment -%}
  {%- assign recipes = site.pages | where: "layout", "recipe" -%}

  {%- assign filtered = "" | split: "" -%}
  {%- for r in recipes -%}
    {%- if page.filter_type == "tag" and page.filter_id and r.tags contains page.filter_id -%}
      {%- assign filtered = filtered | push: r -%}
    {%- elsif page.filter_type == "micro" and page.filter_id and r.badges_nutritionnels contains page.filter_id -%}
      {%- assign filtered = filtered | push: r -%}
    {%- endif -%}
  {%- endfor -%}

  {%- comment -%}
    Compte recettes testées (recipe_tested: true) dans la liste filtrée.
  {%- endcomment -%}
  {%- assign tested_count = 0 -%}
  {%- for r in filtered -%}
    {%- if r.recipe_tested == true -%}
      {%- assign tested_count = tested_count | plus: 1 -%}
    {%- endif -%}
  {%- endfor -%}

  <p class="small text-muted mb-2">
    <strong>{{ filtered.size }}</strong> recette(s).
    <span class="ms-2">Testée(s) : <strong>{{ tested_count }}</strong>.</span>
  </p>

  {%- comment -%}
    Filtre “Seulement les recettes testées”
    - On ne l’affiche que si au moins 1 recette est non testée.
    - Dépend de `.recipe-item[data-tested]` rendu par _includes/recipes-index.html
  {%- endcomment -%}
  {%- if filtered.size > tested_count -%}
    {% include filter-tested.html %}
  {%- endif -%}

  {%- comment -%}
    ===== Bloc descriptif TAG FONCTIONNEL =====
  {%- endcomment -%}
  {%- if page.filter_type == "tag" and page.filter_id -%}
    {%- assign taginfo = site.data.tags_fonctionnels[page.filter_id] -%}
    {%- if taginfo -%}
      <section class="micro-desc">
        <h2>{{ taginfo.titre }}</h2>
        <p>{{ taginfo.signification }}</p>

        {%- if taginfo.criteres -%}
          <h3>Critères d’attribution</h3>
          <ul>
            {%- for c in taginfo.criteres -%}<li>{{ c }}</li>{%- endfor -%}
          </ul>
        {%- endif -%}
      </section>
    {%- endif -%}
  {%- endif -%}

  {%- comment -%}
    ===== Bloc descriptif MICRONUTRIMENT =====
  {%- endcomment -%}
  {%- if page.filter_type == "micro" and page.filter_id -%}
    {%- assign micro = site.data.micronutriments[page.filter_id] -%}
    {%- if micro -%}
      <section class="micro-desc">
        <h2>{{ micro.titre }}</h2>
        <p>{{ micro.resume }}</p>

        <h3>À quoi ça sert ?</h3>
        <ul>{% for r in micro.roles %}<li>{{ r }}</li>{% endfor %}</ul>

        <h3>Quelle dose ?</h3>
        <p><strong>Adulte :</strong> {{ micro.apports.adulte.cible }}</p>

        <h3>Où en trouver ?</h3>
        <ul>{% for f in micro.ou_en_trouver %}<li>{{ f }}</li>{% endfor %}</ul>

        <h3>Comment savoir si j’en manque ?</h3>
        <p>{{ micro.carence.signes }}</p>
      </section>
    {%- endif -%}
  {%- endif -%}

  {%- comment -%}
    ===== Rendu des recettes filtrées =====
    - On regroupe par recipe_group, on nettoie les groupes sans nom,
      puis on rend via l’include factorisé _includes/recipes-index.html
  {%- endcomment -%}

  {%- assign grouped_raw = filtered | group_by: "recipe_group" -%}

  {%- comment -%}
    Nettoyage : on exclut les groupes sans nom (nil / vide) sans where_exp.
  {%- endcomment -%}
  {%- assign grouped = "" | split: "" -%}
  {%- for g in grouped_raw -%}
    {%- if g.name and g.name != "" -%}
      {%- assign grouped = grouped | push: g -%}
    {%- endif -%}
  {%- endfor -%}

  {%- comment -%}
    ✅ Rendu via l’include commun (évite la duplication du HTML des cartes)
  {%- endcomment -%}
  {%- include recipes-index.html grouped=grouped hidden_tags=hidden_tags -%}

</section>

